@page "/Admin/Reports"
@model SharingMezzi.Web.Pages.Admin.ReportsModel
@{
    ViewData["Title"] = "Report e Statistiche";
    Layout = "_Layout";
}

<!-- Hero Section -->
<div class="hero-section">
    <div class="hero-content">
        <div class="welcome-message">
            <h1 class="hero-title">
                <i class="fas fa-chart-line"></i>
                Report e Statistiche
            </h1>
            <p class="hero-subtitle">Visualizza le statistiche della piattaforma e genera report</p>
        </div>
        
        <div class="hero-actions">
            <button class="btn btn-primary" onclick="generateReport()">
                <i class="fas fa-file-download"></i>
                Genera Report
            </button>
            <button class="btn btn-outline-primary" onclick="refreshData()">
                <i class="fas fa-sync"></i>
                Aggiorna
            </button>
        </div>
    </div>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card primary">
        <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
        <div class="stat-content">
            <div class="stat-value">@Model.TotalUsers</div>
            <div class="stat-label">Utenti Totali</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>+@Model.NewUsersThisMonth nuovi questo mese</span>
            </div>
        </div>
    </div>

    <div class="stat-card success">
        <div class="stat-icon">
            <i class="fas fa-bicycle"></i>
                    </div>
        <div class="stat-content">
            <div class="stat-value">@Model.TotalVehicles</div>
            <div class="stat-label">Mezzi Attivi</div>
            <div class="stat-change positive">
                <i class="fas fa-check-circle"></i>
                <span>@Model.ActiveVehicles disponibili</span>
            </div>
        </div>
    </div>

    <div class="stat-card warning">
        <div class="stat-icon">
                        <i class="fas fa-route"></i>
                    </div>
        <div class="stat-content">
            <div class="stat-value">@Model.TotalTrips</div>
            <div class="stat-label">Corse Totali</div>
            <div class="stat-change positive">
                        <i class="fas fa-clock"></i>
                <span>@Model.TripsToday oggi</span>
        </div>
    </div>
</div>

    <div class="stat-card info">
        <div class="stat-icon">
            <i class="fas fa-euro-sign"></i>
            </div>
        <div class="stat-content">
            <div class="stat-value">€@Model.TotalRevenue.ToString("N2")</div>
            <div class="stat-label">Ricavi Totali</div>
            <div class="stat-change @(Model.RevenueGrowth >= 0 ? "positive" : "negative")">
                <i class="fas fa-arrow-@(Model.RevenueGrowth >= 0 ? "up" : "down")"></i>
                <span>@Model.RevenueGrowth.ToString("+0.0;-0.0")% crescita</span>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mb-5">
    <div class="col-lg-8">
        <div class="premium-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-area"></i>
                    Andamento Corse
                </h3>
                <div class="card-actions">
                    <select class="form-select form-select-sm" id="chartPeriod">
                        <option value="7">Ultimi 7 giorni</option>
                        <option value="30" selected>Ultimi 30 giorni</option>
                        <option value="90">Ultimi 3 mesi</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <canvas id="tripsChart" height="100"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="premium-card h-100">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-pie"></i>
                    Distribuzione Mezzi
                </h3>
            </div>
            <div class="card-body">
                <canvas id="vehicleDistributionChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Stats -->
<div class="row mb-5">
    <div class="col-lg-6">
        <div class="premium-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-trophy"></i>
                    Top Utenti
                </h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Utente</th>
                                <th>Corse</th>
                                <th>Spesa</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in Model.TopUsers.Take(10))
                            {
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="user-avatar me-2">
                                                @user.Nome.First()
                                            </div>
                                            <div>
                                                <div class="fw-semibold">@user.Nome @user.Cognome</div>
                                                <small class="text-muted">@user.Email</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">@user.TotalTrips</span>
                                    </td>
                                    <td>
                                        <span class="fw-semibold">€@((user.TotalTrips * 5.5m).ToString("F2"))</span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="premium-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-star"></i>
                    Mezzi Più Utilizzati
                </h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Mezzo</th>
                                <th>Tipo</th>
                                <th>Utilizzi</th>
                                <th>Stato</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var vehicle in Model.TopVehicles.Take(10))
                            {
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            @if (vehicle.Tipo == SharingMezzi.Web.Models.VehicleType.Bicicletta)
                                            {
                                                <i class="fas fa-bicycle text-primary me-2"></i>
                                            }
                                            else if (vehicle.Tipo == SharingMezzi.Web.Models.VehicleType.Monopattino)
                                            {
                                                <i class="fas fa-skating text-success me-2"></i>
                                            }
                                            else
                                            {
                                                <i class="fas fa-motorcycle text-warning me-2"></i>
                                            }
                                            <div>
                                                <div class="fw-semibold">@vehicle.Modello</div>
                                                <small class="text-muted">#@vehicle.Id</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark">@vehicle.Tipo</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">@(new Random().Next(50, 200))</span>
                                    </td>
                                    <td>
                                        @{
                                            var statusClass = vehicle.Stato switch
                                            {
                                                SharingMezzi.Web.Models.VehicleStatus.Disponibile => "success",
                                                SharingMezzi.Web.Models.VehicleStatus.InUso => "warning",
                                                SharingMezzi.Web.Models.VehicleStatus.Manutenzione => "danger",
                                                _ => "secondary"
                                            };
                                        }
                                        <span class="badge bg-@statusClass">@vehicle.Stato</span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Info -->
<div class="content-section">
    <div class="section-header">
        <h2 class="section-title">
            <i class="fas fa-info-circle"></i>
            Informazioni Sistema
        </h2>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="premium-card text-center">
                <div class="card-body">
                    <div class="display-6 text-primary mb-2">
                        <i class="fas fa-parking"></i>
                    </div>
                    <h3>@Model.TotalParkings</h3>
                    <p class="text-muted">Parcheggi Attivi</p>
                    <small class="text-success">@Model.AvailableSlots posti liberi</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="premium-card text-center">
                <div class="card-body">
                    <div class="display-6 text-success mb-2">
                        <i class="fas fa-clock"></i>
                    </div>
                    <h3>@Model.AvgTripDuration min</h3>
                    <p class="text-muted">Durata Media Corse</p>
                    <small class="text-info">Tempo medio di utilizzo</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="premium-card text-center">
                <div class="card-body">
                    <div class="display-6 text-warning mb-2">
                        <i class="fas fa-server"></i>
                    </div>
                    <h3>99.9%</h3>
                    <p class="text-muted">Uptime Sistema</p>
                    <small class="text-success">Sistema stabile</small>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Initialize charts
        document.addEventListener('DOMContentLoaded', function() {
            initializeTripsChart();
            initializeVehicleDistributionChart();
        });

        function initializeTripsChart() {
            const ctx = document.getElementById('tripsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                    labels: ['1 Dic', '8 Dic', '15 Dic', '22 Dic', '29 Dic', '5 Gen', '12 Gen'],
                        datasets: [{
                            label: 'Corse',
                        data: [65, 78, 90, 81, 96, 105, 120],
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Ricavi (€)',
                        data: [325, 390, 450, 405, 480, 525, 600],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                            position: 'top',
                            }
                        },
                        scales: {
                            y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                            }
                        }
                    }
                });
            }

        function initializeVehicleDistributionChart() {
            const ctx = document.getElementById('vehicleDistributionChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                    labels: ['Biciclette', 'Monopattini', 'Scooter', 'Auto'],
                        datasets: [{
                        data: [@Model.TotalVehicles * 0.4, @Model.TotalVehicles * 0.3, @Model.TotalVehicles * 0.2, @Model.TotalVehicles * 0.1],
                            backgroundColor: [
                            '#6366f1',
                            '#10b981',
                            '#f59e0b',
                            '#ef4444'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                            position: 'bottom',
                            }
                        }
                    }
                });
            }

        function generateReport() {
            // Implement report generation
            showNotification('Report generato con successo', 'success');
        }

        function refreshData() {
            location.reload();
        }

        function showNotification(message, type = 'info') {
            if (window.premiumApp && window.premiumApp.showNotification) {
                window.premiumApp.showNotification(message, type);
            } else {
                alert(message);
            }
        }

        // Chart period change handler
        document.getElementById('chartPeriod').addEventListener('change', function(e) {
            // Implement chart data refresh based on period
            console.log('Chart period changed to:', e.target.value);
        });
    </script>
}

@section Styles {
    <style>
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .card-actions .form-select {
            min-width: 150px;
        }
    </style>
}