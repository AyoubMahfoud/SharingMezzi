@page "/Dashboard"
@model SharingMezzi.Web.Pages.DashboardModel
@{
    ViewData["Title"] = "Dashboard";
    Layout = "_Layout";
}

<!-- Hero Section -->
<div class="hero-section">
    <div class="hero-content">
        <div class="welcome-message">
            <h1 class="hero-title">
                <i class="fas fa-hand-wave"></i>
                Bentornato, @Model.CurrentUser?.Nome!
            </h1>
            <p class="hero-subtitle">Ecco una panoramica delle tue attività e dei mezzi disponibili</p>
        </div>
        
        <div class="status-indicators">
            <div class="status-badge online">
                <div class="pulse-dot"></div>
                <span>Sistema Online</span>
            </div>
            <div class="status-badge">
                <i class="fas fa-clock"></i>
                <span>Ultimo aggiornamento: @DateTime.Now.ToString("HH:mm")</span>
            </div>
        </div>
    </div>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card primary">
        <div class="stat-icon">
            <i class="fas fa-bicycle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" id="availableVehicles">@Model.AvailableVehicles</div>
            <div class="stat-label">Mezzi Disponibili</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>+@Model.VehicleGrowth% rispetto a ieri</span>
            </div>
        </div>
    </div>

    <div class="stat-card success">
        <div class="stat-icon">
            <i class="fas fa-route"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" id="totalTrips">@Model.TotalTrips</div>
            <div class="stat-label">Corse Totali</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>+@Model.TripGrowth% questo mese</span>
            </div>
        </div>
    </div>

    <div class="stat-card warning">
        <div class="stat-icon">
            <i class="fas fa-wallet"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">€@Model.CurrentCredit?.ToString("F2")</div>
            <div class="stat-label">Saldo Corrente</div>
            <div class="stat-change">
                <i class="fas fa-info-circle"></i>
                <span>Ultimo addebito @Model.LastChargeDate?.ToString("dd/MM")</span>
            </div>
        </div>
    </div>

    <div class="stat-card info">
        <div class="stat-icon">
            <i class="fas fa-leaf"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">@Model.Co2Saved kg</div>
            <div class="stat-label">CO₂ Risparmiata</div>
            <div class="stat-change positive">
                <i class="fas fa-heart"></i>
                <span>Eco-friendly champion!</span>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Grid -->
<div class="main-content-grid">
    <!-- Quick Actions -->
    <div class="content-card">
        <div class="card-header">
            <h3><i class="fas fa-bolt"></i> Azioni Rapide</h3>
            <p>Le tue funzioni più utilizzate</p>
        </div>
        <div class="quick-actions">
            <a href="/Vehicles" class="action-btn primary">
                <div class="action-icon">
                    <i class="fas fa-search"></i>
                </div>
                <div class="action-content">
                    <span class="action-title">Trova Mezzi</span>
                    <span class="action-desc">@Model.AvailableVehicles mezzi disponibili</span>
                </div>
                <i class="fas fa-chevron-right"></i>
            </a>

            <a href="/Parking" class="action-btn success">
                <div class="action-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="action-content">
                    <span class="action-title">Parcheggi</span>
                    <span class="action-desc">@Model.AvailableParkings stazioni attive</span>
                </div>
                <i class="fas fa-chevron-right"></i>
            </a>

            <a href="/Billing" class="action-btn warning">
                <div class="action-icon">
                    <i class="fas fa-credit-card"></i>
                </div>
                <div class="action-content">
                    <span class="action-title">Ricarica</span>
                    <span class="action-desc">Aggiungi credito</span>
                </div>
                <i class="fas fa-chevron-right"></i>
            </a>

            <a href="/Trips" class="action-btn info">
                <div class="action-icon">
                    <i class="fas fa-history"></i>
                </div>
                <div class="action-content">
                    <span class="action-title">Storico</span>
                    <span class="action-desc">Le tue corse</span>
                </div>
                <i class="fas fa-chevron-right"></i>
            </a>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="content-card">
        <div class="card-header">
            <h3><i class="fas fa-clock"></i> Attività Recenti</h3>
            <p>Le tue ultime azioni</p>
        </div>
        <div class="activity-list">
            @if (Model.RecentTrips?.Any() == true)
            {
                @foreach (var trip in Model.RecentTrips.Take(5))
                {
                    <div class="activity-item">
                        <div class="activity-icon completed">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Corsa completata</div>
                            <div class="activity-desc">@trip.VehicleModel • @trip.Duration min • €@trip.Cost</div>
                            <div class="activity-time">@trip.EndTime?.ToString("dd/MM HH:mm")</div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="no-activity">
                    <i class="fas fa-route"></i>
                    <h4>Nessuna attività recente</h4>
                    <p>Inizia la tua prima corsa per vedere l'attività qui!</p>
                    <a href="/Vehicles" class="btn btn-primary">Trova un Mezzo</a>
                </div>
            }
        </div>
    </div>

    <!-- Weather & Recommendations -->
    <div class="content-card">
        <div class="card-header">
            <h3><i class="fas fa-lightbulb"></i> Suggerimenti</h3>
            <p>Consigli personalizzati per te</p>
        </div>
        <div class="recommendations">
            <div class="recommendation-item eco">
                <div class="rec-icon">
                    <i class="fas fa-leaf"></i>
                </div>
                <div class="rec-content">
                    <h4>Eco Warrior!</h4>
                    <p>Hai risparmiato @Model.Co2Saved kg di CO₂ questo mese. Continua così!</p>
                </div>
            </div>

            @if (Model.CurrentCredit < 5)
            {
                <div class="recommendation-item warning">
                    <div class="rec-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="rec-content">
                        <h4>Credito Basso</h4>
                        <p>Il tuo saldo è di €@Model.CurrentCredit. Considera di ricaricare.</p>
                        <a href="/Billing" class="btn btn-sm btn-warning">Ricarica Ora</a>
                    </div>
                </div>
            }

            <div class="recommendation-item info">
                <div class="rec-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="rec-content">
                    <h4>Obiettivo Mensile</h4>
                    <p>Ancora @(20 - (Model.TotalTrips % 20)) corse per sbloccare il badge "Esploratore"!</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<div class="fab-container">
    <button class="fab" onclick="findNearestVehicle()">
        <i class="fas fa-location-arrow"></i>
    </button>
    <div class="fab-tooltip">Trova mezzo più vicino</div>
</div>

<link rel="stylesheet" href="~/css/dashboard.css" />

<script>
function findNearestVehicle() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            window.location.href = `/Vehicles?lat=${position.coords.latitude}&lng=${position.coords.longitude}`;
        }, function() {
            window.location.href = '/Vehicles';
        });
    } else {
        window.location.href = '/Vehicles';
    }
}

setInterval(function() {
    fetch('/Dashboard?handler=RefreshStats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('availableVehicles').textContent = data.availableVehicles;
            document.getElementById('totalTrips').textContent = data.totalTrips;
        })
        .catch(console.error);
}, 300000);
</script>