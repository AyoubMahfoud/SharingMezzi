@page "/Dashboard"
@model SharingMezzi.Web.Pages.DashboardModel
@{
    ViewData["Title"] = "Dashboard";
    Layout = "_Layout";
    var isAdmin = Model.CurrentUser?.Ruolo == SharingMezzi.Web.Models.UserRole.Admin; // Controlla se è admin
}

<!-- Hero Section -->
<div class="hero-section">
    <div class="hero-content">
        <div class="welcome-message">
            <h1 class="hero-title">
                <i class="fas fa-hand-wave"></i>
                Bentornato, @Model.CurrentUser?.Nome!
                @if (isAdmin)
                {
                    <span class="badge bg-warning ms-2">ADMIN</span>
                }
            </h1>
            <p class="hero-subtitle">Ecco una panoramica delle tue attività e dei mezzi disponibili</p>
        </div>
        
        <div class="status-indicators">
            <div class="status-badge online">
                <div class="pulse-dot"></div>
                <span>Sistema Online</span>
            </div>
            <div class="status-badge">
                <i class="fas fa-clock"></i>
                <span>Ultimo aggiornamento: @DateTime.Now.ToString("HH:mm")</span>
            </div>
        </div>
    </div>
</div>

<!-- Stats Grid (User Stats - Visibili a tutti) -->
<div class="stats-grid">
    <div class="stat-card primary">
        <div class="stat-icon">
            <i class="fas fa-bicycle"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" id="availableVehicles">@Model.AvailableVehicles</div>
            <div class="stat-label">Mezzi Disponibili</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>+@Model.VehicleGrowth% rispetto a ieri</span>
            </div>
        </div>
    </div>

    <div class="stat-card success">
        <div class="stat-icon">
            <i class="fas fa-route"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value" id="totalTrips">@Model.TotalTrips</div>
            <div class="stat-label">Corse Totali</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up"></i>
                <span>+@Model.TripGrowth% questo mese</span>
            </div>
        </div>
    </div>

    <div class="stat-card warning">
        <div class="stat-icon">
            <i class="fas fa-wallet"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">€@Model.CurrentCredit?.ToString("F2")</div>
            <div class="stat-label">Saldo Corrente</div>
            <div class="stat-change">
                <i class="fas fa-info-circle"></i>
                <span>Ultimo addebito @Model.LastChargeDate?.ToString("dd/MM")</span>
            </div>
        </div>
    </div>

    <div class="stat-card info">
        <div class="stat-icon">
            <i class="fas fa-leaf"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">@Model.Co2Saved kg</div>
            <div class="stat-label">CO₂ Risparmiata</div>
            <div class="stat-change positive">
                <i class="fas fa-heart"></i>
                <span>Eco-friendly champion!</span>
            </div>
        </div>
    </div>
</div>

@if (isAdmin)
{
    <!-- ADMIN SECTION - Solo visibile agli amministratori -->
    <div class="admin-section mt-5">
        <div class="section-header mb-4">
            <h3 class="section-title">
                <i class="fas fa-shield-alt"></i>
                Pannello Amministrazione
            </h3>
            <p>Gestisci il sistema e monitora le performance globali</p>
        </div>

        <!-- Admin Stats Grid -->
        <div class="admin-stats-grid">
            <div class="admin-stat-card">
                <div class="admin-stat-header">
                    <div class="admin-stat-icon users">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="admin-stat-menu">
                        <button class="btn-icon" onclick="viewAllUsers()">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
                <div class="admin-stat-body">
                    <h3 class="admin-stat-value">@Model.TotalUsers</h3>
                    <p class="admin-stat-label">Utenti Totali</p>
                    <div class="admin-stat-footer">
                        <span class="text-success">
                            <i class="fas fa-arrow-up"></i> +@Model.NewUsersThisWeek questa settimana
                        </span>
                    </div>
                </div>
            </div>

            <div class="admin-stat-card">
                <div class="admin-stat-header">
                    <div class="admin-stat-icon revenue">
                        <i class="fas fa-euro-sign"></i>
                    </div>
                    <div class="admin-stat-menu">
                        <button class="btn-icon" onclick="viewRevenue()">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
                <div class="admin-stat-body">
                    <h3 class="admin-stat-value">€@Model.TotalRevenue.ToString("N2")</h3>
                    <p class="admin-stat-label">Ricavi Totali</p>
                    <div class="admin-stat-footer">
                        <span class="text-success">
                            <i class="fas fa-arrow-up"></i> @Model.RevenueGrowth.ToString("+0.0;-0.0")% questo mese
                        </span>
                    </div>
                </div>
            </div>

            <div class="admin-stat-card">
                <div class="admin-stat-header">
                    <div class="admin-stat-icon maintenance">
                        <i class="fas fa-tools"></i>
                    </div>
                    <div class="admin-stat-menu">
                        <button class="btn-icon" onclick="viewMaintenance()">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
                <div class="admin-stat-body">
                    <h3 class="admin-stat-value">@Model.MaintenanceVehicles</h3>
                    <p class="admin-stat-label">In Manutenzione</p>
                    <div class="admin-stat-footer">
                        <span class="text-warning">
                            <i class="fas fa-exclamation-triangle"></i> @Model.UrgentMaintenance urgenti
                        </span>
                    </div>
                </div>
            </div>

            <div class="admin-stat-card">
                <div class="admin-stat-header">
                    <div class="admin-stat-icon reports">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="admin-stat-menu">
                        <button class="btn-icon" onclick="viewReports()">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
                <div class="admin-stat-body">
                    <h3 class="admin-stat-value">@Model.OpenReports</h3>
                    <p class="admin-stat-label">Segnalazioni Aperte</p>
                    <div class="admin-stat-footer">
                        <span class="text-danger">
                            <i class="fas fa-clock"></i> @Model.PendingReports in attesa
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Quick Actions -->
        <div class="admin-actions mt-4">
            <h4 class="mb-3">Gestione Rapida</h4>
            <div class="admin-action-grid">
                <button class="admin-action-btn" data-admin-target="/Admin/Users">
                    <i class="fas fa-user-cog"></i>
                    <span>Gestione Utenti</span>
                </button>
                <button class="admin-action-btn" data-admin-target="/Admin/Vehicles">
                    <i class="fas fa-bicycle"></i>
                    <span>Gestione Mezzi</span>
                </button>
                <button class="admin-action-btn" data-admin-target="/Admin/Reports">
                    <i class="fas fa-chart-line"></i>
                    <span>Report & Analytics</span>
                </button>
                <button class="admin-action-btn" data-admin-target="/Admin/Maintenance">
                    <i class="fas fa-wrench"></i>
                    <span>Manutenzioni</span>
                </button>
                <button class="admin-action-btn" onclick="window.location.href='/Admin/Payments'">
                    <i class="fas fa-money-bill"></i>
                    <span>Transazioni</span>
                </button>
                <button class="admin-action-btn" onclick="window.location.href='/Admin/Settings'">
                    <i class="fas fa-cog"></i>
                    <span>Impostazioni</span>
                </button>
            </div>
        </div>

        <!-- Admin Activity Table -->
        <div class="admin-activity mt-4">
            <div class="activity-header">
                <h4>Attività Sistema in Tempo Reale</h4>
                <button class="btn btn-sm btn-outline-light" onclick="exportActivity()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Tipo</th>
                            <th>Utente</th>
                            <th>Azione</th>
                            <th>Stato</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var activity in Model.SystemActivities.Take(5))
                        {
                            <tr>
                                <td>@activity.Timestamp.ToString("HH:mm:ss")</td>
                                <td>
                                    <span class="badge bg-@activity.TypeColor">@activity.Type</span>
                                </td>
                                <td>@activity.UserName</td>
                                <td>@activity.Description</td>
                                <td>
                                    <span class="badge bg-@activity.StatusColor">@activity.Status</span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

<!-- Main Content Grid (per tutti gli utenti) -->
<div class="main-content-grid">
    <!-- Quick Actions -->
    <div class="content-card">
        <div class="card-header">
            <h3><i class="fas fa-bolt"></i> Azioni Rapide</h3>
            <p>Le tue funzioni più utilizzate</p>
        </div>
        <div class="quick-actions">
            <a href="/Vehicles" class="action-btn primary">
                <div class="action-icon">
                    <i class="fas fa-search"></i>
                </div>
                <div class="action-content">
                    <span class="action-title">Trova Mezzi</span>
                    <span class="action-desc">@Model.AvailableVehicles mezzi disponibili</span>
                </div>
                <i class="fas fa-chevron-right"></i>
            </a>

            <a href="/Parking" class="action-btn success">
                <div class="action-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="action-content">
                    <span class="action-title">Parcheggi</span>
                    <span class="action-desc">@Model.AvailableParkings stazioni attive</span>
                </div>
                <i class="fas fa-chevron-right"></i>
            </a>

            <a href="/Billing" class="action-btn warning">
                <div class="action-icon">
                    <i class="fas fa-credit-card"></i>
                </div>
                <div class="action-content">
                    <span class="action-title">Ricarica</span>
                    <span class="action-desc">Aggiungi credito</span>
                </div>
                <i class="fas fa-chevron-right"></i>
            </a>

            <a href="/Trips" class="action-btn info">
                <div class="action-icon">
                    <i class="fas fa-history"></i>
                </div>
                <div class="action-content">
                    <span class="action-title">Storico</span>
                    <span class="action-desc">Le tue corse</span>
                </div>
                <i class="fas fa-chevron-right"></i>
            </a>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="content-card">
        <div class="card-header">
            <h3><i class="fas fa-clock"></i> Attività Recenti</h3>
            <p>Le tue ultime azioni</p>
        </div>
        <div class="activity-list">
            @if (Model.RecentTrips?.Any() == true)
            {
                @foreach (var trip in Model.RecentTrips.Take(5))
                {
                    <div class="activity-item">
                        <div class="activity-icon completed">
                            <i class="fas fa-check"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Corsa completata</div>
                            <div class="activity-desc">@trip.VehicleModel • @trip.Duration min • €@trip.Cost</div>
                            <div class="activity-time">@trip.EndTime?.ToString("dd/MM HH:mm")</div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="no-activity">
                    <i class="fas fa-route"></i>
                    <h4>Nessuna attività recente</h4>
                    <p>Inizia la tua prima corsa per vedere l'attività qui!</p>
                    <a href="/Vehicles" class="btn btn-primary">Trova un Mezzo</a>
                </div>
            }
        </div>
    </div>

    <!-- Weather & Recommendations -->
    <div class="content-card">
        <div class="card-header">
            <h3><i class="fas fa-lightbulb"></i> Suggerimenti</h3>
            <p>Consigli personalizzati per te</p>
        </div>
        <div class="recommendations">
            <div class="recommendation-item eco">
                <div class="rec-icon">
                    <i class="fas fa-leaf"></i>
                </div>
                <div class="rec-content">
                    <h4>Eco Warrior!</h4>
                    <p>Hai risparmiato @Model.Co2Saved kg di CO₂ questo mese. Continua così!</p>
                </div>
            </div>

            @if (Model.CurrentCredit < 5)
            {
                <div class="recommendation-item warning">
                    <div class="rec-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="rec-content">
                        <h4>Credito Basso</h4>
                        <p>Il tuo saldo è di €@Model.CurrentCredit. Considera di ricaricare.</p>
                        <a href="/Billing" class="btn btn-sm btn-warning">Ricarica Ora</a>
                    </div>
                </div>
            }

            <div class="recommendation-item info">
                <div class="rec-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="rec-content">
                    <h4>Obiettivo Mensile</h4>
                    <p>Ancora @(20 - (Model.TotalTrips % 20)) corse per sbloccare il badge "Esploratore"!</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<div class="fab-container">
    <button class="fab" onclick="findNearestVehicle()">
        <i class="fas fa-location-arrow"></i>
    </button>
    <div class="fab-tooltip">Trova mezzo più vicino</div>
</div>

<link rel="stylesheet" href="~/css/dashboard.css" />

<style>
/* Admin Section Styles */
.admin-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    padding: 30px;
    color: white;
    margin-top: 30px;
}

.admin-section .section-title {
    color: white;
    font-weight: 600;
    font-size: 1.8rem;
}

.admin-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.admin-stat-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.admin-stat-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.admin-stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.admin-stat-icon.users { background: rgba(59, 130, 246, 0.3); }
.admin-stat-icon.revenue { background: rgba(34, 197, 94, 0.3); }
.admin-stat-icon.maintenance { background: rgba(251, 191, 36, 0.3); }
.admin-stat-icon.reports { background: rgba(239, 68, 68, 0.3); }

.admin-stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: white;
    margin: 0;
}

.admin-stat-label {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
    margin: 5px 0;
}

.admin-action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
}

.admin-action-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 15px;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    transition: all 0.3s;
}

.admin-action-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
}

.admin-action-btn i {
    font-size: 1.5rem;
}

.admin-activity {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 15px;
    padding: 20px;
    margin-top: 20px;
}

.activity-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.btn-icon {
    background: transparent;
    border: none;
    color: white;
    cursor: pointer;
    padding: 5px;
}
</style>

<script>
// Funzioni esistenti
function findNearestVehicle() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            window.location.href = `/Vehicles?lat=${position.coords.latitude}&lng=${position.coords.longitude}`;
        }, function() {
            window.location.href = '/Vehicles';
        });
    } else {
        window.location.href = '/Vehicles';
    }
}

// Funzioni Admin
function ensureSessionAndNavigate(href) {
    try {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (!token) {
            window.location.href = href;
            return;
        }

    // POST token to server session and wait shortly, then navigate
    const apiBase = (window.authManager && window.authManager.apiBaseUrl) ? window.authManager.apiBaseUrl.replace(/\/$/, '') : (location.port === '5050' ? `${location.protocol}//${location.hostname}:5000` : `${location.protocol}//${location.host}`);
    // POST to API
        fetch(location.origin + '/Auth/SetSession', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token })
        }).catch(() => null).finally(() => {
            // small delay to give server time to set session cookie
            setTimeout(() => window.location.href = href, 200);
        });
    } catch (e) {
        console.debug('ensureSessionAndNavigate error', e);
        window.location.href = href;
    }
}

function viewAllUsers() { ensureSessionAndNavigate('/Admin/Users'); }
function viewRevenue() { ensureSessionAndNavigate('/Admin/Reports'); }
function viewMaintenance() { ensureSessionAndNavigate('/Admin/Maintenance'); }
function viewReports() { ensureSessionAndNavigate('/Admin/Reports'); }

function exportActivity() {
    alert('Esportazione attività in corso...');
}

// Refresh automatico stats
setInterval(function() {
    fetch('/Dashboard?handler=RefreshStats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('availableVehicles').textContent = data.availableVehicles;
            document.getElementById('totalTrips').textContent = data.totalTrips;
        })
        .catch(console.error);
}, 300000);
</script>